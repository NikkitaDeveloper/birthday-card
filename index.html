<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chat# Executor ‚Äî Single-file IDE</title>
<style>
  :root{
    --bg:#06101a; --panel:#0d1724; --muted:#9fb3d9; --accent:#22c55e; --err:#ff7b7b;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#031018,#071021);color:#dbeeff}
  header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
  header h1{font-size:15px;margin:0}
  .toolbar{margin-left:auto;display:flex;gap:8px;align-items:center}
  button, select{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  main{display:grid;grid-template-columns:1fr 420px;gap:12px;padding:12px;height:calc(100vh - 64px)}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px}
  textarea{width:100%;height:calc(100% - 160px);resize:none;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#cfe8ff;padding:12px;border-radius:8px;font-family:var(--mono);font-size:13px;line-height:1.5}
  .right{display:flex;flex-direction:column;gap:8px}
  .preview{flex:1;background:#000;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  iframe#preview{width:100%;height:100%;border:0}
  .console{height:220px;background:#071020;border-radius:8px;padding:10px;overflow:auto;border:1px solid rgba(255,255,255,0.03);font-family:var(--mono);font-size:13px;color:#9be6a0}
  .console .err{color:var(--err)}
  .small{font-size:12px;color:var(--muted)}
  .help{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
  footer{padding:8px 16px;color:var(--muted);font-size:12px;text-align:center}
  @media (max-width:1000px){ main{grid-template-columns:1fr;grid-template-rows:auto 360px} .preview{height:200px} }
</style>
</head>
<body>

<header>
  <h1>Chat# Executor ‚Äî Run ¬∑ Debug ¬∑ Step ¬∑ Errors</h1>
  <div class="toolbar">
    <select id="langSelect" title="Choose language">
      <option value="chat#">chat# (interpreter)</option>
      <option value="html">HTML</option>
      <option value="css">CSS</option>
      <option value="js">JS</option>
    </select>
    <button id="runBtn">Run ‚ñ∂</button>
    <button id="debugBtn">Debug ‚ñ∂</button>
    <button id="stepBtn">Step ‚è≠</button>
    <button id="pauseBtn">Pause ‚è∏</button>
    <button id="stopBtn">Stop ‚õî</button>
    <button id="errorBtn">Find Errors üîç</button>
    <button id="clearBtn">Clear</button>
    <button id="downloadBtn">Download</button>
  </div>
</header>

<main>
  <div class="panel">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="small">File: <strong id="fileName">main.chat</strong></div>
      <div style="flex:1"></div>
      <div class="small">Ctrl/Cmd + Enter ‚Üí Run</div>
    </div>

    <textarea id="editor" spellcheck="false"></textarea>

    <div style="display:flex;align-items:center;gap:8px">
      <div class="help" style="flex:1">
        <strong>chat# quick:</strong>
        <div>print("hello") ‚Äî prints</div>
        <div>let x = 5  or  x = 5 ‚Äî variables</div>
        <div>fn name(a,b){ return a+b }</div>
        <div>while(cond){ ... }  if(cond){ ... } else { ... }</div>
      </div>
      <div style="width:8px"></div>
    </div>
  </div>

  <div class="right">
    <div class="preview" id="previewWrap">
      <iframe id="preview" sandbox="allow-scripts"></iframe>
    </div>

    <div class="console" id="console"></div>
  </div>
</main>

<footer>Local only ‚Äî single file Chat# executor</footer>

<script>
/* ---------------- Samples ---------------- */
const samples = {
  "chat#": `# Chat# sample
let x = 0
while (x < 5) {
  print("x:", x)
  x = x + 1
}
fn add(a,b) {
  return a + b
}
print("add:", add(2,3))`,

  "html": `<h1 style="color:#22c55e">Hello from HTML</h1>
<p id="p">Preview area</p>`,

  "css": `body{font-family:system-ui; background:#071021; color:#cfe8ff}`,

  "js": `console.log("Hello from JS"); document.getElementById("p") && (document.getElementById("p").textContent = "Changed by JS");`
};

/* ---------------- UI elements ---------------- */
const editor = document.getElementById('editor');
const langSelect = document.getElementById('langSelect');
const fileNameEl = document.getElementById('fileName');
const runBtn = document.getElementById('runBtn');
const debugBtn = document.getElementById('debugBtn');
const stepBtn = document.getElementById('stepBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const errorBtn = document.getElementById('errorBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');
const preview = document.getElementById('preview');
const consoleEl = document.getElementById('console');

let currentLang = 'chat#';
let env = {};            // persistent state for debug/step
let stepStatements = []; // statements queue for stepper
let stepIndex = 0;
let runningAuto = false;
let paused = false;
let stepTimer = null;

/* ---------------- Init ---------------- */
function loadSample(lang){
  editor.value = samples[lang] || '';
  fileNameEl.textContent = (lang === 'chat#') ? 'main.chat' : (lang === 'html' ? 'index.html' : (lang === 'css' ? 'styles.css' : 'app.js'));
  clearConsole();
  if(lang !== 'html') preview.srcdoc = blankPreview();
}
loadSample(currentLang);

langSelect.addEventListener('change', ()=>{
  currentLang = langSelect.value;
  loadSample(currentLang);
});

/* ---------------- Console helpers ---------------- */
function appendConsole(msg, cls){
  const d = document.createElement('div');
  d.textContent = msg;
  if(cls) d.classList.add(cls);
  consoleEl.appendChild(d);
  consoleEl.scrollTop = consoleEl.scrollHeight;
}
function clearConsole(){ consoleEl.innerHTML = ''; }
function blankPreview(){ return '<!doctype html><meta charset="utf-8"><body style="background:#071021;color:#cfe8ff;display:flex;align-items:center;justify-content:center"><div style="max-width:600px;padding:20px;text-align:center;"><strong>Preview</strong><p class="small">Run HTML/CSS/JS to load preview here.</p></div></body>'; }

/* ---------------- Error finder ---------------- */
function findErrors(code){
  const errs = [];
  // bracket stack check for (), {}, []
  const stack = [];
  const pairs = {'(':')','{':'}','[':']'};
  for(let i=0;i<code.length;i++){
    const ch = code[i];
    if(ch === '"' || ch === "'"){
      const q = ch; let j = i+1, closed=false;
      while(j<code.length){
        if(code[j]===q && code[j-1] !== '\\'){ closed=true; break; }
        j++;
      }
      if(!closed) errs.push('Unclosed quote at pos '+i);
      i = j;
      continue;
    }
    if(pairs[ch]) stack.push({ch,pos:i});
    else if(Object.values(pairs).includes(ch)){
      const top = stack.pop();
      if(!top || pairs[top.ch] !== ch) errs.push('Mismatched '+ch+' at pos '+i);
    }
  }
  if(stack.length) errs.push('Unclosed '+stack[stack.length-1].ch+' at pos '+stack[stack.length-1].pos);
  return errs;
}

/* ---------------- chat# transpiler -> statements ---------------- */
function transpileChatToStatements(code){
  // Remove line comments: // and # (simple)
  const lines = code.split('\\n').map(l=>{
    let idx = l.indexOf('//');
    const idx2 = l.indexOf('#');
    if(idx2 >= 0 && (idx < 0 || idx2 < idx)) idx = idx2;
    return (idx >= 0) ? l.slice(0, idx) : l;
  }).join('\\n');

  // basic replacements
  let js = lines;
  js = js.replace(/\\bfn\\s+(\\w+)\\s*\\(/g, 'function $1(');
  js = js.replace(/\\bprint\\s*\\(/g, '__print(');
  js = js.replace(/\\band\\b/g,'&&').replace(/\\bor\\b/g,'||').replace(/\\bnot\\b/g,'!');
  js = js.replace(/\\belif\\b/g,'else if');

  // rewrite let/var declarations -> env.x = 
  js = js.replace(/\\b(let|var)\\s+([a-zA-Z_$][\\w$]*)\\s*=\\s*/g, function(_,p1,p2){ return 'env.'+p2+' = '; });

  // bare assignments at start of line -> env.x =
  js = js.replace(/^\\s*([a-zA-Z_$][\\w$]*)\\s*=/gm, function(m,p1){ return m.replace(p1, 'env.'+p1); });

  // Now split into statements while respecting braces depth and strings
  const stmts = [];
  let cur = '', depth = 0, i=0, n=js.length, inStr=false, strChar='';
  while(i<n){
    const ch = js[i];
    cur += ch;
    if(inStr){
      if(ch === strChar && js[i-1] !== '\\'){ inStr = false; strChar=''; }
      i++; continue;
    } else {
      if(ch === '"' || ch === "'"){ inStr = true; strChar = ch; i++; continue; }
      if(ch === '{'){ depth++; i++; continue; }
      if(ch === '}'){ depth = Math.max(0, depth-1); i++; continue; }
      if((ch === ';' || ch === '\\n') && depth === 0){
        const s = cur.trim();
        if(s) stmts.push(s.replace(/;\\s*$/,''));
        cur = '';
        i++; continue;
      }
      i++;
    }
  }
  if(cur.trim()) stmts.push(cur.trim().replace(/;\\s*$/,''));
  return stmts;
}

/* ---------------- Runner / Stepper ---------------- */
function __print(...args){
  try{
    const s = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
    appendConsole(s);
  }catch(e){ appendConsole('Print error: '+e,'err'); }
}

function runChatFull(source){
  clearConsole();
  try{
    const stmts = transpileChatToStatements(source);
    // combine and run inside env
    env = {}; // fresh env for full run
    const combined = stmts.join('\\n');
    const fn = new Function('env','__print','range','with(env){'+combined+'}');
    fn(env,__print, n=> { const a=[]; for(let i=0;i<n;i++) a.push(i); return a; });
  }catch(e){
    appendConsole('Runtime Error: '+e,'err');
  }
}

function runJSFull(source){
  clearConsole();
  try{
    const fn = new Function('__print', source);
    fn(__print);
  }catch(e){
    appendConsole('JS Error: '+e,'err');
  }
}

function runHTMLPreview(){
  clearConsole();
  const html = (currentLang === 'html') ? editor.value : samples['html'];
  const css = (currentLang === 'css') ? editor.value : samples['css'];
  const js = (currentLang === 'js') ? editor.value : samples['js'];
  const src = `<!doctype html><html><head><meta charset="utf-8"><style>${css}</style></head><body>${html}
<script>
(function(){
  function send(t,m){ parent.postMessage({type:t,msg:String(m)}, '*'); }
  console.log = function(){ send('log', Array.from(arguments).join(' ')); }
  console.error = function(){ send('err', Array.from(arguments).join(' ')); }
  window.onerror = function(msg,src,line){ send('err', msg+' (line:'+line+')'); }
  try{ ${js} }catch(e){ send('err', e); }
})();
<\/script></body></html>`;
  preview.srcdoc = src;
}

/* Stepper execution of single statement */
function executeStatement(stmt){
  try{
    const fn = new Function('env','__print','with(env){'+stmt+'}');
    fn(env,__print);
    appendConsole('> ' + stmt);
  }catch(e){
    appendConsole('Runtime Error: '+e,'err');
    runningAuto = false;
    clearTimeout(stepTimer);
  }
}

/* Prepare stepper */
function prepareStepperForChat(source){
  const statements = transpileChatToStatements(source);
  stepStatements = statements;
  stepIndex = 0;
  env = env || {};
  appendConsole('Prepared ' + stepStatements.length + ' statements');
}

/* Auto-run stepper */
function autoRunStepper(delay=200){
  if(stepIndex >= stepStatements.length){ appendConsole('Stepper finished'); runningAuto=false; return; }
  if(paused){ appendConsole('Paused'); runningAuto=false; return; }
  runningAuto = true;
  executeStatement(stepStatements[stepIndex++]);
  stepTimer = setTimeout(()=> autoRunStepper(delay), delay);
}

/* ---------------- Button wiring ---------------- */
runBtn.addEventListener('click', ()=>{
  clearConsole();
  if(currentLang === 'chat#'){
    const src = editor.value;
    const errs = findErrors(src);
    if(errs.length){ appendConsole('Static Errors:', 'err'); errs.forEach(e=>appendConsole(' - '+e,'err')); return; }
    runChatFull(src);
  } else if(currentLang === 'js'){
    runJSFull(editor.value);
  } else {
    runHTMLPreview();
  }
});

debugBtn.addEventListener('click', ()=>{
  clearConsole();
  const src = editor.value;
  const errs = findErrors(src);
  if(errs.length){ appendConsole('Static Errors:', 'err'); errs.forEach(e=>appendConsole(' - '+e,'err')); return; }
  if(currentLang === 'chat#'){
    prepareStepperForChat(src);
    paused = false;
    autoRunStepper(250);
  } else if(currentLang === 'js'){
    // naive split by newline/semicolon
    const parts = editor.value.split(/;|\\n/).map(s=>s.trim()).filter(Boolean);
    stepStatements = parts;
    stepIndex = 0;
    env = {};
    autoRunStepper(250);
  } else {
    appendConsole('Debugger for chat# and JS only yet.', 'err');
  }
});

stepBtn.addEventListener('click', ()=>{
  if(stepStatements.length === 0){
    const src = editor.value;
    const errs = findErrors(src);
    if(errs.length){ appendConsole('Static Errors:', 'err'); errs.forEach(e=>appendConsole(' - '+e,'err')); return; }
    if(currentLang === 'chat#') prepareStepperForChat(src);
    else if(currentLang === 'js') { stepStatements = editor.value.split(/;|\\n/).map(s=>s.trim()).filter(Boolean); stepIndex=0; env = {}; }
  }
  if(stepIndex < stepStatements.length){
    executeStatement(stepStatements[stepIndex++]);
  } else appendConsole('No more statements.');
});

pauseBtn.addEventListener('click', ()=>{
  paused = !paused;
  appendConsole(paused ? 'Paused' : 'Resumed');
  if(!paused && stepStatements.length && !runningAuto) autoRunStepper(250);
});

stopBtn.addEventListener('click', ()=>{
  runningAuto = false; paused = false; stepStatements = []; stepIndex = 0; env = {}; clearTimeout(stepTimer);
  appendConsole('Stopped and env cleared.');
});

errorBtn.addEventListener('click', ()=>{
  clearConsole();
  const src = editor.value;
  const errs = findErrors(src);
  if(errs.length) { appendConsole('Static Errors:', 'err'); errs.forEach(e=>appendConsole(' - '+e,'err')); }
  else appendConsole('No static errors found.');
});

clearBtn.addEventListener('click', ()=>{
  editor.value = ''; clearConsole(); preview.srcdoc = blankPreview();
});

downloadBtn.addEventListener('click', ()=>{
  const text = editor.value;
  const name = fileNameEl.textContent || 'file.txt';
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
});

/* Receive messages from preview iframe */
window.addEventListener('message', (ev)=>{
  if(!ev.data) return;
  const t = ev.data.type, m = ev.data.msg;
  if(t === 'log') appendConsole(m);
  if(t === 'err') appendConsole(m, 'err');
});

/* keyboard: Ctrl/Cmd+Enter run */
editor.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); runBtn.click(); }
});

/* initial preview */
preview.srcdoc = blankPreview();
</script>

</body>
</html>